"use strict";var XTAL=(()=>{var x=class{constructor(e,r){this.controller=null;this.apiBase=e,this.shopId=r}async fetchConfig(){let e=await fetch(`${this.apiBase}/api/xtal/config?shopId=${encodeURIComponent(this.shopId)}`,{mode:"cors"});if(!e.ok)throw new Error(`Config fetch failed: ${e.status}`);return e.json()}async searchFull(e,r=16,a){this.controller&&this.controller.abort(),this.controller=new AbortController;let s=await fetch(`${this.apiBase}/api/xtal/search-full`,{method:"POST",mode:"cors",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:e,collection:this.shopId,limit:r,selected_aspects:a}),signal:this.controller.signal});if(!s.ok)throw new Error(`Search failed: ${s.status}`);return s.json()}};var C=class{constructor(e){this.target=e,this.originalHTML=e.innerHTML}showLoading(){this.target.innerHTML="";let e=document.createElement("div");e.style.cssText="display:flex;align-items:center;justify-content:center;padding:60px 20px;gap:8px;color:#888;font-size:14px;";let r=document.createElement("div");r.style.cssText="width:16px;height:16px;border:2px solid #ccc;border-top-color:#555;border-radius:50%;animation:xtal-inline-spin .6s linear infinite;";let a=document.createElement("span");if(a.textContent="Searching...",e.appendChild(r),e.appendChild(a),!document.getElementById("xtal-inline-keyframes")){let s=document.createElement("style");s.id="xtal-inline-keyframes",s.textContent="@keyframes xtal-inline-spin{to{transform:rotate(360deg)}}",document.head.appendChild(s)}this.target.appendChild(e)}renderCards(e){this.target.innerHTML="";for(let r of e)this.target.appendChild(r)}renderEmpty(e){this.target.innerHTML="";let r=document.createElement("div");r.style.cssText="text-align:center;padding:60px 20px;color:#888;font-size:14px;",r.textContent=`No results found for "${e}"`,this.target.appendChild(r)}restore(){this.target.innerHTML=this.originalHTML}destroy(){this.restore();let e=document.getElementById("xtal-inline-keyframes");e&&e.remove()}};function h(t,e){try{let r=new URL(t);return r.searchParams.set("utm_source","xtal"),r.searchParams.set("utm_medium","search"),r.searchParams.set("utm_campaign",e.shopId),r.searchParams.set("utm_content",e.productId),r.searchParams.set("utm_term",e.query),r.toString()}catch{return t}}function S(t){let e=Array.isArray(t.price)?t.price[0]??0:t.price,r=t.variants?.[0]?.compare_at_price,a={id:t.id??"",title:t.title??"",vendor:t.vendor??"",product_type:t.product_type??"",price:e.toFixed(2),image_url:t.image_url||t.featured_image||t.images?.[0]?.src||"",product_url:t.product_url??"",available:t.available?"true":"",description:t.description??""};r&&r>e&&(a.compare_at_price=r.toFixed(2));let s=t.variants?.[0];if(s&&(s.sku&&(a.sku=s.sku),s.title&&(a.variant_title=s.title)),t.tags?.length){a.tags=t.tags.join(", ");for(let n of t.tags){let l=n.indexOf(":");if(l>0){let o=n.slice(0,l).trim().toLowerCase().replace(/\s+/g,"_"),p=n.slice(l+1).trim();o&&p&&!(o in a)&&(a[o]=p)}}}return a}function k(t,e){let r=t.replace(/\{\{#(\w+)\}\}([\s\S]*?)\{\{\/\1\}\}/g,(a,s,n)=>e[s]?n:"");return r=r.replace(/\{\{\^(\w+)\}\}([\s\S]*?)\{\{\/\1\}\}/g,(a,s,n)=>e[s]?"":n),r}function $(t,e){return t.replace(/\{\{(\w+)\}\}/g,(r,a)=>e[a]??"")}function N(t){let e=document.createElement("div");return e.innerHTML=t.trim(),e.firstElementChild||e}function v(t,e,r,a,s){let n=S(e),l=k(t,n);l=$(l,n);let o=N(l),p=h(e.product_url||"#",{shopId:a,productId:e.id,query:r});return o.querySelectorAll('[data-xtal-action="view-product"]').forEach(i=>{i.tagName==="A"?(i.href=p,i.target="_blank",i.rel="noopener noreferrer"):(i.style.cursor="pointer",i.addEventListener("click",d=>{d.preventDefault(),s.onViewProduct(e)}))}),o.querySelectorAll('[data-xtal-action="add-to-cart"]').forEach(i=>{i.addEventListener("click",async d=>{d.preventDefault(),d.stopPropagation();let c=i.textContent;i.textContent="Adding...",i.style.opacity="0.7",i.style.pointerEvents="none";try{await s.onAddToCart(e)}finally{i.textContent=c,i.style.opacity="",i.style.pointerEvents=""}})}),o}function j(t){if(Array.isArray(t)){let e=[...t].sort((r,a)=>r-a);return e.length===0?"N/A":e.length===1||e[0]===e[e.length-1]?`$${e[0].toFixed(2)}`:`$${e[0].toFixed(2)} \u2013 $${e[e.length-1].toFixed(2)}`}return`$${t.toFixed(2)}`}function I(t,e,r,a,s){if(a&&s)return v(a.html,t,e,r,s);let n=t.image_url||t.featured_image||t.images&&t.images[0]?.src,l=document.createElement("a");l.className="xtal-card",l.href=h(t.product_url||"#",{shopId:r,productId:t.id,query:e}),l.target="_blank",l.rel="noopener noreferrer";let o=document.createElement("div");if(o.className="xtal-card-image",n){let c=document.createElement("img");c.src=n,c.alt=t.title,c.loading="lazy",o.appendChild(c)}else{let c=document.createElement("span");c.className="xtal-card-image-placeholder",c.textContent="No image",o.appendChild(c)}l.appendChild(o);let p=document.createElement("div");if(p.className="xtal-card-body",t.vendor){let c=document.createElement("div");c.className="xtal-card-vendor",c.textContent=t.vendor,p.appendChild(c)}let i=document.createElement("div");i.className="xtal-card-title",i.textContent=t.title,p.appendChild(i);let d=document.createElement("div");return d.className="xtal-card-price",d.textContent=j(t.price),p.appendChild(d),l.appendChild(p),l}function H(t,e){let r=null,a=null,s=[];function n(o){let p=o.closest("form");if(p){let d=c=>{c.preventDefault();let u=o.value.trim();u.length>=1&&e(u)};p.addEventListener("submit",d),s.push(()=>p.removeEventListener("submit",d))}let i=d=>{if(d.key==="Enter"){d.preventDefault();let c=o.value.trim();c.length>=1&&e(c)}};o.addEventListener("keydown",i),s.push(()=>o.removeEventListener("keydown",i))}let l=document.querySelector(t);return l?(n(l),()=>s.forEach(o=>o())):(r=new MutationObserver(o=>{for(let p of o)for(let i of Array.from(p.addedNodes)){if(!(i instanceof HTMLElement))continue;let d=i.matches(t)?i:i.querySelector(t);if(d){n(d),r?.disconnect(),r=null,a&&clearTimeout(a),a=null;return}}}),r.observe(document.body,{childList:!0,subtree:!0}),a=setTimeout(()=>{r?.disconnect(),r=null,console.warn(`[xtal.js] Could not find input matching "${t}" after 10s`)},1e4),()=>{s.forEach(o=>o()),r?.disconnect(),r=null,a&&clearTimeout(a)})}function U(t){return typeof t=="string"&&t.includes("/")?t.split("/").pop():t}var T=class{constructor(){this.name="shopify"}async addToCart(e,r=1){let a=e.variants?.[0]?.id;if(!a)return{success:!1,message:"No variant available"};if(!e.available)return{success:!1,message:"Product unavailable"};let s=U(a);try{let n=await fetch("/cart/add.js",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:s,quantity:r})});return n.ok?{success:!0,message:"Added to cart"}:n.status===422?{success:!1,message:(await n.json().catch(()=>({}))).description||"Could not add to cart"}:{success:!1,message:`Cart error (${n.status})`}}catch(n){return{success:!1,message:n instanceof Error?n.message:"Network error"}}}};var E=class{constructor(e,r){this.name="fallback";this.shopId=e,this.queryFn=r}async addToCart(e){let r=h(e.product_url||"#",{shopId:this.shopId,productId:e.id,query:this.queryFn()});return window.open(r,"_blank","noopener,noreferrer"),{success:!0,message:"Opening product page..."}}};function P(t,e){return window.Shopify?new T:new E(t,e)}function M(){try{let t=document.querySelector("script[data-shop-id]");if(!t){console.warn("[xtal.js] No <script data-shop-id> tag found");return}let e=t.getAttribute("data-shop-id")??"";if(!e){console.warn("[xtal.js] data-shop-id is empty");return}let r="",a=t.getAttribute("src");if(a)try{r=new URL(a,window.location.href).origin}catch{r=window.location.origin}else r=window.location.origin;let s=new x(r,e);s.fetchConfig().then(n=>{if(!n.enabled){console.log(`[xtal.js] Snippet disabled for ${e}`);return}let l=n.cardTemplate??null,o="",p=P(e,()=>o);console.log(`[xtal.js] Cart adapter: ${p.name}`);function i(u){if(n.productUrlPattern){let y=u.variants?.[0]?.sku||"";if(y)return n.productUrlPattern.replace("{sku}",encodeURIComponent(y)).replace("{id}",u.id||"")}let f=u.product_url||"#";return!f||f==="#"?"#":f.startsWith("http://")||f.startsWith("https://")?f:n.siteUrl?n.siteUrl.replace(/\/$/,"")+f:f}let d=n.displayMode==="inline"&&!!n.resultsSelector,c=d?document.querySelector(n.resultsSelector):null;if(d&&!c){console.log(`[xtal.js] Inline mode: "${n.resultsSelector}" not found \u2014 standing by`);return}{let u=new C(c),f=null,y={onViewProduct(g){let m=h(i(g),{shopId:e,productId:g.id,query:o});window.open(m,"_blank","noopener,noreferrer")},async onAddToCart(g){let m=await p.addToCart(g);console.log(`[xtal.js] Add to cart: ${m.success?"OK":"FAIL"} \u2014 ${m.message}`),m.success&&fetch(`${r}/api/xtal/events`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({product_id:g.id,action:"add_to_cart",collection:e,query:o})}).catch(()=>{})}},w=g=>{o=g,u.showLoading(),s.searchFull(g,16).then(m=>{if(m.results.length===0){u.renderEmpty(g);return}let A=m.results.map(_=>l?v(l.html,_,g,e,y):I(_,g,e,null,y));u.renderCards(A)}).catch(m=>{m instanceof DOMException&&m.name==="AbortError"||(console.error("[xtal.js] Search error:",m),u.restore())})},b=n.searchSelector||'input[type="search"]';f=H(b,w);let L=document.querySelector(b);L?.value?.trim()&&w(L.value.trim()),window.XTAL={destroy(){f?.(),u.destroy(),delete window.XTAL}},console.log(`[xtal.js] Initialized INLINE for ${e}. Search: ${b}, Grid: ${n.resultsSelector}`)}}).catch(n=>{console.error("[xtal.js] Failed to fetch config:",n)})}catch(t){console.error("[xtal.js] Boot error:",t)}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",M):M();})();
