"use strict";var XTAL=(()=>{var x=class{constructor(e,r){this.controller=null;this.apiBase=e,this.shopId=r}async fetchConfig(){let e=await fetch(`${this.apiBase}/api/xtal/config?shopId=${encodeURIComponent(this.shopId)}`,{mode:"cors"});if(!e.ok)throw new Error(`Config fetch failed: ${e.status}`);return e.json()}async searchFull(e,r=16,a){this.controller&&this.controller.abort(),this.controller=new AbortController;let s=await fetch(`${this.apiBase}/api/xtal/search-full`,{method:"POST",mode:"cors",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:e,collection:this.shopId,limit:r,selected_aspects:a}),signal:this.controller.signal});if(!s.ok)throw new Error(`Search failed: ${s.status}`);return s.json()}};var C=class{constructor(e){this.target=e,this.originalHTML=e.innerHTML}showLoading(){this.target.innerHTML="";let e=document.createElement("div");e.style.cssText="display:flex;align-items:center;justify-content:center;padding:60px 20px;gap:8px;color:#888;font-size:14px;";let r=document.createElement("div");r.style.cssText="width:16px;height:16px;border:2px solid #ccc;border-top-color:#555;border-radius:50%;animation:xtal-inline-spin .6s linear infinite;";let a=document.createElement("span");if(a.textContent="Searching...",e.appendChild(r),e.appendChild(a),!document.getElementById("xtal-inline-keyframes")){let s=document.createElement("style");s.id="xtal-inline-keyframes",s.textContent="@keyframes xtal-inline-spin{to{transform:rotate(360deg)}}",document.head.appendChild(s)}this.target.appendChild(e)}renderCards(e){this.target.innerHTML="";let r=document.createElement("div");r.className="xtal-grid";for(let a of e)r.appendChild(a);this.target.appendChild(r)}renderEmpty(e){this.target.innerHTML="";let r=document.createElement("div");r.style.cssText="text-align:center;padding:60px 20px;color:#888;font-size:14px;",r.textContent=`No results found for "${e}"`,this.target.appendChild(r)}restore(){this.target.innerHTML=this.originalHTML}destroy(){this.restore();let e=document.getElementById("xtal-inline-keyframes");e&&e.remove()}};function h(t,e){try{let r=new URL(t);return r.searchParams.set("utm_source","xtal"),r.searchParams.set("utm_medium","search"),r.searchParams.set("utm_campaign",e.shopId),r.searchParams.set("utm_content",e.productId),r.searchParams.set("utm_term",e.query),r.toString()}catch{return t}}function N(t){let e=Array.isArray(t.price)?t.price[0]??0:t.price,r=t.variants?.[0]?.compare_at_price,a={id:t.id??"",title:t.title??"",vendor:t.vendor??"",product_type:t.product_type??"",price:e.toFixed(2),image_url:t.image_url||t.featured_image||t.images?.[0]?.src||"",product_url:t.product_url??"",available:t.available?"true":"",description:t.description??""};r&&r>e&&(a.compare_at_price=r.toFixed(2));let s=t.variants?.[0];if(s&&(s.sku&&(a.sku=s.sku),s.title&&(a.variant_title=s.title)),t.tags?.length){a.tags=t.tags.join(", ");for(let n of t.tags){let c=n.indexOf(":");if(c>0){let i=n.slice(0,c).trim().toLowerCase().replace(/\s+/g,"_"),d=n.slice(c+1).trim();i&&d&&!(i in a)&&(a[i]=d)}}}return a}function U(t,e){let r=t.replace(/\{\{#(\w+)\}\}([\s\S]*?)\{\{\/\1\}\}/g,(a,s,n)=>e[s]?n:"");return r=r.replace(/\{\{\^(\w+)\}\}([\s\S]*?)\{\{\/\1\}\}/g,(a,s,n)=>e[s]?"":n),r}function j(t,e){return t.replace(/\{\{(\w+)\}\}/g,(r,a)=>e[a]??"")}function F(t){let e=document.createElement("div");return e.innerHTML=t.trim(),e.firstElementChild||e}function v(t,e,r,a,s,n){let c=N(e),i=U(t,c);i=j(i,c);let d=F(i),m=h(e.product_url||"#",{shopId:a,productId:e.id,query:r});return d.querySelectorAll('[data-xtal-action="view-product"]').forEach(o=>{o.tagName==="A"?(o.href=m,o.target="_blank",o.rel="noopener noreferrer"):(o.style.cursor="pointer",o.addEventListener("click",l=>{l.preventDefault(),s.onViewProduct(e)}))}),d.querySelectorAll('[data-xtal-action="add-to-cart"]').forEach(o=>{n==="fallback"&&(o.textContent="View Product"),o.addEventListener("click",async l=>{l.preventDefault(),l.stopPropagation();let p=o.textContent;o.textContent="Adding...",o.style.opacity="0.7",o.style.pointerEvents="none";try{await s.onAddToCart(e)}finally{o.textContent=p,o.style.opacity="",o.style.pointerEvents=""}})}),d}function R(t){if(Array.isArray(t)){let e=[...t].sort((r,a)=>r-a);return e.length===0?"N/A":e.length===1||e[0]===e[e.length-1]?`$${e[0].toFixed(2)}`:`$${e[0].toFixed(2)} \u2013 $${e[e.length-1].toFixed(2)}`}return`$${t.toFixed(2)}`}function P(t,e,r,a,s){if(a&&s)return v(a.html,t,e,r,s);let n=t.image_url||t.featured_image||t.images&&t.images[0]?.src,c=document.createElement("a");c.className="xtal-card",c.href=h(t.product_url||"#",{shopId:r,productId:t.id,query:e}),c.target="_blank",c.rel="noopener noreferrer";let i=document.createElement("div");if(i.className="xtal-card-image",n){let l=document.createElement("img");l.src=n,l.alt=t.title,l.loading="lazy",i.appendChild(l)}else{let l=document.createElement("span");l.className="xtal-card-image-placeholder",l.textContent="No image",i.appendChild(l)}c.appendChild(i);let d=document.createElement("div");if(d.className="xtal-card-body",t.vendor){let l=document.createElement("div");l.className="xtal-card-vendor",l.textContent=t.vendor,d.appendChild(l)}let m=document.createElement("div");m.className="xtal-card-title",m.textContent=t.title,d.appendChild(m);let o=document.createElement("div");return o.className="xtal-card-price",o.textContent=R(t.price),d.appendChild(o),c.appendChild(d),c}function S(t,e){let r=null,a=null,s=[];function n(i){let d=i.closest("form");if(d){let o=l=>{l.preventDefault(),l.stopImmediatePropagation();let p=i.value.trim();p.length>=1&&e(p)};d.addEventListener("submit",o,!0),s.push(()=>d.removeEventListener("submit",o,!0))}let m=o=>{if(o.key==="Enter"){o.preventDefault(),o.stopImmediatePropagation();let l=i.value.trim();l.length>=1&&e(l)}};i.addEventListener("keydown",m,!0),s.push(()=>i.removeEventListener("keydown",m,!0))}let c=document.querySelector(t);return c?(n(c),()=>s.forEach(i=>i())):(r=new MutationObserver(i=>{for(let d of i)for(let m of Array.from(d.addedNodes)){if(!(m instanceof HTMLElement))continue;let o=m.matches(t)?m:m.querySelector(t);if(o){n(o),r?.disconnect(),r=null,a&&clearTimeout(a),a=null;return}}}),r.observe(document.body,{childList:!0,subtree:!0}),a=setTimeout(()=>{r?.disconnect(),r=null,console.warn(`[xtal.js] Could not find input matching "${t}" after 10s`)},1e4),()=>{s.forEach(i=>i()),r?.disconnect(),r=null,a&&clearTimeout(a)})}function q(t){return typeof t=="string"&&t.includes("/")?t.split("/").pop():t}var T=class{constructor(){this.name="shopify"}async addToCart(e,r=1){let a=e.variants?.[0]?.id;if(!a)return{success:!1,message:"No variant available"};if(!e.available)return{success:!1,message:"Product unavailable"};let s=q(a);try{let n=await fetch("/cart/add.js",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:s,quantity:r})});return n.ok?{success:!0,message:"Added to cart"}:n.status===422?{success:!1,message:(await n.json().catch(()=>({}))).description||"Could not add to cart"}:{success:!1,message:`Cart error (${n.status})`}}catch(n){return{success:!1,message:n instanceof Error?n.message:"Network error"}}}};var E=class{constructor(e,r){this.name="fallback";this.shopId=e,this.queryFn=r}async addToCart(e){let r=h(e.product_url||"#",{shopId:this.shopId,productId:e.id,query:this.queryFn()});return window.open(r,"_blank","noopener,noreferrer"),{success:!0,message:"Opening product page..."}}};function H(t,e){return window.Shopify?new T:new E(t,e)}function M(t,e,r,a){try{let s=JSON.stringify({action:"error",collection:e,error:r,context:a,ts:Date.now()});navigator.sendBeacon&&navigator.sendBeacon(`${t}/api/xtal/events`,s)}catch{}}function A(){try{let t=document.querySelector("script[data-shop-id]");if(!t){console.warn("[xtal.js] No <script data-shop-id> tag found");return}let e=t.getAttribute("data-shop-id")??"";if(!e){console.warn("[xtal.js] data-shop-id is empty");return}let r="",a=t.getAttribute("src");if(a)try{r=new URL(a,window.location.href).origin}catch{r=window.location.origin}else r=window.location.origin;let s=new x(r,e);s.fetchConfig().then(n=>{if(!n.enabled){console.log(`[xtal.js] Snippet disabled for ${e}`);return}let c=n.cardTemplate??null;if(c?.css){let p=document.getElementById("xtal-card-styles");p&&p.remove();let g=document.createElement("style");g.id="xtal-card-styles",g.textContent=c.css,document.head.appendChild(g)}let i="",d=H(e,()=>i);console.log(`[xtal.js] Cart adapter: ${d.name}`);function m(p){if(n.productUrlPattern){let y=p.variants?.[0]?.sku||"";if(y)return n.productUrlPattern.replace("{sku}",encodeURIComponent(y)).replace("{id}",p.id||"")}let g=p.product_url||"#";return!g||g==="#"?"#":g.startsWith("http://")||g.startsWith("https://")?g:n.siteUrl?n.siteUrl.replace(/\/$/,"")+g:g}let o=n.displayMode==="inline"&&!!n.resultsSelector,l=o?document.querySelector(n.resultsSelector):null;if(o&&!l){console.log(`[xtal.js] Inline mode: "${n.resultsSelector}" not found \u2014 standing by`);return}{let p=new C(l),g=null,y={onViewProduct(u){let f=h(m(u),{shopId:e,productId:u.id,query:i});window.open(f,"_blank","noopener,noreferrer")},async onAddToCart(u){let f=await d.addToCart(u);console.log(`[xtal.js] Add to cart: ${f.success?"OK":"FAIL"} \u2014 ${f.message}`),f.success&&fetch(`${r}/api/xtal/events`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({product_id:u.id,action:"add_to_cart",collection:e,query:i})}).catch(()=>{})}},L=u=>{i=u,p.showLoading(),s.searchFull(u,24).then(f=>{if(f.results.length===0){p.renderEmpty(u);return}let k=f.results.map(I=>c?v(c.html,I,u,e,y,d.name):P(I,u,e,null,y));p.renderCards(k)}).catch(f=>{f instanceof DOMException&&f.name==="AbortError"||(console.error("[xtal.js] Search error:",f),M(r,e,String(f),"search"),p.restore(),n.siteUrl&&i&&(window.location.href=`${n.siteUrl.replace(/\/$/,"")}/shop/?Search=${encodeURIComponent(i)}`))})},b=null,$=u=>{b&&clearTimeout(b),b=setTimeout(()=>L(u),200)},w=n.searchSelector||'input[type="search"]';g=S(w,$);let _=document.querySelector(w);_?.value?.trim()&&L(_.value.trim()),window.XTAL={destroy(){g?.(),p.destroy();let u=document.getElementById("xtal-card-styles");u&&u.remove(),delete window.XTAL}},console.log(`[xtal.js] Initialized INLINE for ${e}. Search: ${w}, Grid: ${n.resultsSelector}`)}}).catch(n=>{console.error("[xtal.js] Failed to fetch config:",n),M(r,e,String(n),"config")})}catch(t){console.error("[xtal.js] Boot error:",t)}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",A):A();})();
