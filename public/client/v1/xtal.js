"use strict";var XTAL=(()=>{var x=class{constructor(e,r){this.controller=null;this.apiBase=e,this.shopId=r}async fetchConfig(){let e=await fetch(`${this.apiBase}/api/xtal/config?shopId=${encodeURIComponent(this.shopId)}`,{mode:"cors"});if(!e.ok)throw new Error(`Config fetch failed: ${e.status}`);return e.json()}async searchFull(e,r=16,a){this.controller&&this.controller.abort(),this.controller=new AbortController;let o=await fetch(`${this.apiBase}/api/xtal/search-full`,{method:"POST",mode:"cors",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:e,collection:this.shopId,limit:r,selected_aspects:a}),signal:this.controller.signal});if(!o.ok)throw new Error(`Search failed: ${o.status}`);return o.json()}};var C=class{constructor(e){this.target=e,this.originalHTML=e.innerHTML}showLoading(){this.target.innerHTML="";let e=document.createElement("div");e.style.cssText="display:flex;align-items:center;justify-content:center;padding:60px 20px;gap:8px;color:#888;font-size:14px;";let r=document.createElement("div");r.style.cssText="width:16px;height:16px;border:2px solid #ccc;border-top-color:#555;border-radius:50%;animation:xtal-inline-spin .6s linear infinite;";let a=document.createElement("span");if(a.textContent="Searching...",e.appendChild(r),e.appendChild(a),!document.getElementById("xtal-inline-keyframes")){let o=document.createElement("style");o.id="xtal-inline-keyframes",o.textContent="@keyframes xtal-inline-spin{to{transform:rotate(360deg)}}",document.head.appendChild(o)}this.target.appendChild(e)}renderCards(e){this.target.innerHTML="";for(let r of e)this.target.appendChild(r)}renderEmpty(e){this.target.innerHTML="";let r=document.createElement("div");r.style.cssText="text-align:center;padding:60px 20px;color:#888;font-size:14px;",r.textContent=`No results found for "${e}"`,this.target.appendChild(r)}restore(){this.target.innerHTML=this.originalHTML}destroy(){this.restore();let e=document.getElementById("xtal-inline-keyframes");e&&e.remove()}};function h(t,e){try{let r=new URL(t);return r.searchParams.set("utm_source","xtal"),r.searchParams.set("utm_medium","search"),r.searchParams.set("utm_campaign",e.shopId),r.searchParams.set("utm_content",e.productId),r.searchParams.set("utm_term",e.query),r.toString()}catch{return t}}function N(t){let e=Array.isArray(t.price)?t.price[0]??0:t.price,r=t.variants?.[0]?.compare_at_price,a={id:t.id??"",title:t.title??"",vendor:t.vendor??"",product_type:t.product_type??"",price:e.toFixed(2),image_url:t.image_url||t.featured_image||t.images?.[0]?.src||"",product_url:t.product_url??"",available:t.available?"true":"",description:t.description??""};r&&r>e&&(a.compare_at_price=r.toFixed(2));let o=t.variants?.[0];if(o&&(o.sku&&(a.sku=o.sku),o.title&&(a.variant_title=o.title)),t.tags?.length){a.tags=t.tags.join(", ");for(let n of t.tags){let d=n.indexOf(":");if(d>0){let i=n.slice(0,d).trim().toLowerCase().replace(/\s+/g,"_"),c=n.slice(d+1).trim();i&&c&&!(i in a)&&(a[i]=c)}}}return a}function U(t,e){let r=t.replace(/\{\{#(\w+)\}\}([\s\S]*?)\{\{\/\1\}\}/g,(a,o,n)=>e[o]?n:"");return r=r.replace(/\{\{\^(\w+)\}\}([\s\S]*?)\{\{\/\1\}\}/g,(a,o,n)=>e[o]?"":n),r}function j(t,e){return t.replace(/\{\{(\w+)\}\}/g,(r,a)=>e[a]??"")}function F(t){let e=document.createElement("div");return e.innerHTML=t.trim(),e.firstElementChild||e}function v(t,e,r,a,o,n){let d=N(e),i=U(t,d);i=j(i,d);let c=F(i),p=h(e.product_url||"#",{shopId:a,productId:e.id,query:r});return c.querySelectorAll('[data-xtal-action="view-product"]').forEach(s=>{s.tagName==="A"?(s.href=p,s.target="_blank",s.rel="noopener noreferrer"):(s.style.cursor="pointer",s.addEventListener("click",l=>{l.preventDefault(),o.onViewProduct(e)}))}),c.querySelectorAll('[data-xtal-action="add-to-cart"]').forEach(s=>{n==="fallback"&&(s.textContent="View Product"),s.addEventListener("click",async l=>{l.preventDefault(),l.stopPropagation();let u=s.textContent;s.textContent="Adding...",s.style.opacity="0.7",s.style.pointerEvents="none";try{await o.onAddToCart(e)}finally{s.textContent=u,s.style.opacity="",s.style.pointerEvents=""}})}),c}function R(t){if(Array.isArray(t)){let e=[...t].sort((r,a)=>r-a);return e.length===0?"N/A":e.length===1||e[0]===e[e.length-1]?`$${e[0].toFixed(2)}`:`$${e[0].toFixed(2)} \u2013 $${e[e.length-1].toFixed(2)}`}return`$${t.toFixed(2)}`}function P(t,e,r,a,o){if(a&&o)return v(a.html,t,e,r,o);let n=t.image_url||t.featured_image||t.images&&t.images[0]?.src,d=document.createElement("a");d.className="xtal-card",d.href=h(t.product_url||"#",{shopId:r,productId:t.id,query:e}),d.target="_blank",d.rel="noopener noreferrer";let i=document.createElement("div");if(i.className="xtal-card-image",n){let l=document.createElement("img");l.src=n,l.alt=t.title,l.loading="lazy",i.appendChild(l)}else{let l=document.createElement("span");l.className="xtal-card-image-placeholder",l.textContent="No image",i.appendChild(l)}d.appendChild(i);let c=document.createElement("div");if(c.className="xtal-card-body",t.vendor){let l=document.createElement("div");l.className="xtal-card-vendor",l.textContent=t.vendor,c.appendChild(l)}let p=document.createElement("div");p.className="xtal-card-title",p.textContent=t.title,c.appendChild(p);let s=document.createElement("div");return s.className="xtal-card-price",s.textContent=R(t.price),c.appendChild(s),d.appendChild(c),d}function H(t,e){let r=null,a=null,o=[];function n(i){let c=i.closest("form");if(c){let s=l=>{l.preventDefault(),l.stopImmediatePropagation();let u=i.value.trim();u.length>=1&&e(u)};c.addEventListener("submit",s,!0),o.push(()=>c.removeEventListener("submit",s,!0))}let p=s=>{if(s.key==="Enter"){s.preventDefault(),s.stopImmediatePropagation();let l=i.value.trim();l.length>=1&&e(l)}};i.addEventListener("keydown",p,!0),o.push(()=>i.removeEventListener("keydown",p,!0))}let d=document.querySelector(t);return d?(n(d),()=>o.forEach(i=>i())):(r=new MutationObserver(i=>{for(let c of i)for(let p of Array.from(c.addedNodes)){if(!(p instanceof HTMLElement))continue;let s=p.matches(t)?p:p.querySelector(t);if(s){n(s),r?.disconnect(),r=null,a&&clearTimeout(a),a=null;return}}}),r.observe(document.body,{childList:!0,subtree:!0}),a=setTimeout(()=>{r?.disconnect(),r=null,console.warn(`[xtal.js] Could not find input matching "${t}" after 10s`)},1e4),()=>{o.forEach(i=>i()),r?.disconnect(),r=null,a&&clearTimeout(a)})}function q(t){return typeof t=="string"&&t.includes("/")?t.split("/").pop():t}var T=class{constructor(){this.name="shopify"}async addToCart(e,r=1){let a=e.variants?.[0]?.id;if(!a)return{success:!1,message:"No variant available"};if(!e.available)return{success:!1,message:"Product unavailable"};let o=q(a);try{let n=await fetch("/cart/add.js",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:o,quantity:r})});return n.ok?{success:!0,message:"Added to cart"}:n.status===422?{success:!1,message:(await n.json().catch(()=>({}))).description||"Could not add to cart"}:{success:!1,message:`Cart error (${n.status})`}}catch(n){return{success:!1,message:n instanceof Error?n.message:"Network error"}}}};var E=class{constructor(e,r){this.name="fallback";this.shopId=e,this.queryFn=r}async addToCart(e){let r=h(e.product_url||"#",{shopId:this.shopId,productId:e.id,query:this.queryFn()});return window.open(r,"_blank","noopener,noreferrer"),{success:!0,message:"Opening product page..."}}};function S(t,e){return window.Shopify?new T:new E(t,e)}function M(t,e,r,a){try{let o=JSON.stringify({action:"error",collection:e,error:r,context:a,ts:Date.now()});navigator.sendBeacon&&navigator.sendBeacon(`${t}/api/xtal/events`,o)}catch{}}function A(){try{let t=document.querySelector("script[data-shop-id]");if(!t){console.warn("[xtal.js] No <script data-shop-id> tag found");return}let e=t.getAttribute("data-shop-id")??"";if(!e){console.warn("[xtal.js] data-shop-id is empty");return}let r="",a=t.getAttribute("src");if(a)try{r=new URL(a,window.location.href).origin}catch{r=window.location.origin}else r=window.location.origin;let o=new x(r,e);o.fetchConfig().then(n=>{if(!n.enabled){console.log(`[xtal.js] Snippet disabled for ${e}`);return}let d=n.cardTemplate??null,i="",c=S(e,()=>i);console.log(`[xtal.js] Cart adapter: ${c.name}`);function p(u){if(n.productUrlPattern){let y=u.variants?.[0]?.sku||"";if(y)return n.productUrlPattern.replace("{sku}",encodeURIComponent(y)).replace("{id}",u.id||"")}let f=u.product_url||"#";return!f||f==="#"?"#":f.startsWith("http://")||f.startsWith("https://")?f:n.siteUrl?n.siteUrl.replace(/\/$/,"")+f:f}let s=n.displayMode==="inline"&&!!n.resultsSelector,l=s?document.querySelector(n.resultsSelector):null;if(s&&!l){console.log(`[xtal.js] Inline mode: "${n.resultsSelector}" not found \u2014 standing by`);return}{let u=new C(l),f=null,y={onViewProduct(m){let g=h(p(m),{shopId:e,productId:m.id,query:i});window.open(g,"_blank","noopener,noreferrer")},async onAddToCart(m){let g=await c.addToCart(m);console.log(`[xtal.js] Add to cart: ${g.success?"OK":"FAIL"} \u2014 ${g.message}`),g.success&&fetch(`${r}/api/xtal/events`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({product_id:m.id,action:"add_to_cart",collection:e,query:i})}).catch(()=>{})}},_=m=>{i=m,u.showLoading(),o.searchFull(m,24).then(g=>{if(g.results.length===0){u.renderEmpty(m);return}let k=g.results.map(I=>d?v(d.html,I,m,e,y,c.name):P(I,m,e,null,y));u.renderCards(k)}).catch(g=>{g instanceof DOMException&&g.name==="AbortError"||(console.error("[xtal.js] Search error:",g),M(r,e,String(g),"search"),u.restore(),n.siteUrl&&i&&(window.location.href=`${n.siteUrl.replace(/\/$/,"")}/search-results/?search_field=${encodeURIComponent(i)}`))})},b=null,$=m=>{b&&clearTimeout(b),b=setTimeout(()=>_(m),200)},w=n.searchSelector||'input[type="search"]';f=H(w,$);let L=document.querySelector(w);L?.value?.trim()&&_(L.value.trim()),window.XTAL={destroy(){f?.(),u.destroy(),delete window.XTAL}},console.log(`[xtal.js] Initialized INLINE for ${e}. Search: ${w}, Grid: ${n.resultsSelector}`)}}).catch(n=>{console.error("[xtal.js] Failed to fetch config:",n),M(r,e,String(n),"config")})}catch(t){console.error("[xtal.js] Boot error:",t)}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",A):A();})();
